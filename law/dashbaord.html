<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nyame Na Aye - Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* (use same styles as you used before) */
:root{--bg:#f3f4f6;--card:#fff;--primary:#3b82f6}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#222}
aside{width:200px;background:var(--card);position:fixed;height:100%;padding:20px;box-shadow:2px 0 6px rgba(0,0,0,0.05)}
main{margin-left:220px;padding:20px}
.card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06);margin-bottom:12px}
button{padding:6px 10px;border-radius:6px;border:none;background:var(--primary);color:#fff;cursor:pointer}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:6px;border:1px solid #e8e8e8}
</style>
</head>
<body>
<aside>
  <h2>Nyame Na Aye</h2>
  <nav>
    <div><a href="#" onclick="show('dashboard')">Dashboard</a></div>
    <div><a href="#" onclick="show('products')">Products</a></div>
    <div><a href="#" onclick="show('sales')">Sales</a></div>
    <div><a href="#" onclick="show('reports')">Reports</a></div>
    <div><a href="#" onclick="logout()">Logout</a></div>
  </nav>
</aside>

<main>
  <div id="dashboard" class="card">
    <h3>Overview</h3>
    <div id="cardsRow">
      <div class="card"><strong>Sales Today</strong><div id="salesToday">GHS 0</div></div>
      <div class="card"><strong>Profit</strong><div id="profitToday">GHS 0</div></div>
      <div class="card"><strong>Total Qty</strong><div id="totalQuantity">0</div></div>
      <div class="card"><strong>Low stock</strong><div id="lowStock">0</div></div>
    </div>
    <canvas id="salesChart" style="max-width:100%;height:220px"></canvas>
  </div>

  <div id="products" class="card" style="display:none">
    <h3>Products</h3>
    <form id="productForm">
      <input id="pName" placeholder="Name" required> <input id="pStock" type="number" placeholder="Stock" min="0" required> <input id="pPrice" type="number" placeholder="Price" step="0.01" min="0" required>
      <button type="submit">Add</button>
    </form>
    <table class="table" id="productTable"><thead><tr><th>#</th><th>Name</th><th>Stock</th><th>Price</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="sales" class="card" style="display:none">
    <h3>Sales</h3>
    <form id="saleForm">
      <select id="saleProduct"></select>
      <input id="saleQty" type="number" min="1" required>
      <button type="submit">Record</button>
    </form>
    <table class="table" id="salesTable"><thead><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th><th>Action</th></tr></thead><tbody></tbody></table>
  </div>

  <div id="reports" class="card" style="display:none">
    <h3>Reports</h3>
    <button onclick="printReport()">Print</button>
    <div id="reportContent"></div>
  </div>
</main>

<script>
const API = "";

function show(id){
  ["dashboard","products","sales","reports"].forEach(x=>document.getElementById(x).style.display = (x===id)?'block':'none');
  if(id==='products') loadProducts();
  if(id==='sales') loadSales();
  if(id==='dashboard') loadDashboard();
}
function logout(){localStorage.removeItem('user'); location.href='/'}

let products=[], sales=[];
async function loadProducts(){
  try{
    const res = await fetch(API + '/api/products');
    products = await res.json();
    renderProducts();
    populateSaleSelect();
  }catch(e){console.error(e)}
}
function renderProducts(){
  const tbody = document.querySelector("#productTable tbody"); tbody.innerHTML = "";
  products.forEach((p,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${p.name}</td><td>${p.stock}</td><td>GHS ${p.price.toFixed(2)}</td>
      <td><button onclick="editProduct(${p.id})">Edit</button> <button onclick="deleteProduct(${p.id})">Del</button></td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById("productForm").onsubmit = async e => {
  e.preventDefault();
  const name = document.getElementById("pName").value;
  const stock = parseInt(document.getElementById("pStock").value||0);
  const price = parseFloat(document.getElementById("pPrice").value||0);
  await fetch(API + '/api/products', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,stock,price})});
  document.getElementById("productForm").reset();
  await loadProducts();
};

async function editProduct(id){
  const p = products.find(x=>x.id===id);
  const name = prompt("Name", p.name);
  const stock = parseInt(prompt("Stock", p.stock));
  const price = parseFloat(prompt("Price", p.price));
  if(!name || isNaN(stock) || isNaN(price)) return;
  await fetch(API + `/api/products/${id}`, {method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name,stock,price})});
  await loadProducts();
}
async function deleteProduct(id){
  if(!confirm("Delete?")) return;
  await fetch(API + `/api/products/${id}`, {method:'DELETE'});
  await loadProducts();
}

// Sales
async function loadSales(){
  const res = await fetch(API + '/api/sales');
  sales = await res.json();
  renderSales();
  await loadProducts(); // refresh stock numbers
}
function renderSales(){
  const tbody = document.querySelector("#salesTable tbody"); tbody.innerHTML = "";
  sales.forEach((s,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td>
      <td><button onclick="deleteSale(${s.id})">Del</button></td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById("saleForm").onsubmit = async e => {
  e.preventDefault();
  const product_id = parseInt(document.getElementById("saleProduct").value);
  const qty = parseInt(document.getElementById("saleQty").value);
  const res = await fetch(API + '/api/sales', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({product_id, qty})});
  const data = await res.json();
  if(res.ok){ await loadSales(); document.getElementById("saleForm").reset(); }
  else { alert(data.error || "Sale error"); }
};
async function deleteSale(id){
  if(!confirm("Delete sale?")) return;
  await fetch(API + `/api/sales/${id}`, {method:'DELETE'});
  await loadSales();
}
function populateSaleSelect(){
  const sel = document.getElementById("saleProduct"); sel.innerHTML = "";
  products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name} (${p.stock})</option>`);
}

// Dashboard chart/cards
let chart;
async function loadDashboard(){
  await loadProducts();
  await loadSales();
  updateCards();
  updateChart();
}
function updateCards(){
  const today = new Date().toISOString().slice(0,10);
  const salesToday = sales.reduce((a,s)=> a + (s.date===today ? s.amount : 0), 0);
  document.getElementById("salesToday").textContent = 'GHS ' + salesToday.toFixed(2);
  document.getElementById("profitToday").textContent = 'GHS ' + (salesToday * 0.2).toFixed(2);
  document.getElementById("totalQuantity").textContent = products.reduce((a,p)=>a+p.stock,0);
  document.getElementById("lowStock").textContent = products.filter(p=>p.stock<5).length;
}
function updateChart(){
  const ctx = document.getElementById('salesChart').getContext('2d');
  const labels = sales.map(s => s.date);
  const data = sales.map(s => s.amount);
  if(chart) { chart.data.labels = labels; chart.data.datasets[0].data = data; chart.update(); return; }
  chart = new Chart(ctx, {type:'line', data:{labels, datasets:[{label:'Sales', data, borderColor:'var(--primary)', tension:0.3}]}, options:{responsive:true}});
}
function printReport(){
  let html = "<h3>Sales Report</h3><table border='1' cellpadding='6'><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th></tr>";
  sales.forEach((s,i)=> html += `<tr><td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td></tr>`);
  html += "</table>";
  const w = window.open("", "_blank");
  w.document.write(html);
  w.print();
}

// init
(async function(){ 
  const user = JSON.parse(localStorage.getItem('user')||'{}');
  if(!user || !user.username) location.href = '/';
  await loadDashboard();
})();
</script>
</body>
</html>
