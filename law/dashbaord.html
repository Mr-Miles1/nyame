<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nyame Na Aye - Supermarket Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg-color:#f3f4f6;
  --text-color:#333;
  --card-bg:#fff;
  --primary-color:#3b82f6;
}
body.dark {
  --bg-color:#121212;
  --text-color:#e0e0e0;
  --card-bg:#1e1e1e;
  --primary-color:#10b981;
}
body {
  margin:0; font-family:Arial,sans-serif; display:flex; min-height:100vh;
  background:var(--bg-color); color:var(--text-color); overflow-x:hidden; font-size:14px;
}
/* Sidebar */
aside {width:200px; background:var(--card-bg); box-shadow:2px 0 5px rgba(0,0,0,0.1);
display:flex; flex-direction:column; padding:35px 15px; overflow-y:auto; position:fixed; height:100%; transition:transform 0.3s ease, left 0.3s ease; z-index:100; left:-23px;}
aside h2 {font-size:22px; margin-bottom:15px; display:flex; align-items:center; justify-content:space-between; padding-left:10px;}
aside h2 .close-btn {display:none; font-size:22px; cursor:pointer;}
nav a {display:flex; align-items:center; gap:8px; padding:6px 10px; margin-bottom:5px; text-decoration:none; color:var(--text-color); border-radius:6px; transition:0.2s; cursor:pointer;}
nav a:hover {background:rgba(59,130,246,0.1); color:var(--primary-color);}
nav a.logout:hover {background:#fee2e2;color:#b91c1c;}
nav a.logout {margin-top:auto;}
/* Main Content */
main {flex:1; padding:15px; margin-left:200px; transition:margin-left 0.3s ease;}
/* Header */
header {display:flex; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; margin-bottom:15px;}
header h1 {font-size:22px;margin:0;}
.user-info {display:flex; flex-direction:row; align-items:center; gap:8px; flex-wrap:wrap; background:var(--card-bg); padding:8px 12px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); font-size:13px;}
.user-info img {width:35px; height:35px; border-radius:50%; object-fit:cover;}
/* Cards */
.cards {display:grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-bottom:15px;}
.card {background:var(--card-bg); padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center;}
.card span.icon {font-size:28px; display:block; margin-bottom:5px;}
.card .title {font-weight:bold; margin-bottom:3px; font-size:13px;}
.card .value {font-size:14px;}
/* Sections */
section {display:none;}
section.active {display:block;}
/* Loading */
#loadingOverlay {position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:none; justify-content:center; align-items:center; z-index:50;}
.spinner {border:5px solid #f3f3f3; border-top:5px solid var(--primary-color); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;}
@keyframes spin { to { transform:rotate(360deg); } }
/* Table & Form */
table {width:100%; border-collapse:collapse; margin-top:10px; font-size:12px;}
th, td {padding:6px; border:1px solid #ddd; text-align:left;}
th {background:#f3f4f6;}
body.dark th {background:#1a1a1a;}
button {padding:4px 8px; border:none; border-radius:6px; cursor:pointer; transition:0.2s; margin:2px; background:var(--primary-color); color:#fff; font-size:12px;}
button:hover {opacity:0.9;}
input, select {padding:5px; margin:4px 0; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; font-size:13px;}
.search-box {margin-bottom:8px; padding:5px; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box; font-size:13px;}
.btn-edit {background:#facc15;}
.btn-delete {background:#ef4444;}
.btn-print {background:#f59e0b;}
.settings {display:flex; flex-direction:column; gap:8px; margin-top:10px;}
/* Hamburger */
.hamburger {display:none;font-size:22px;cursor:pointer;margin-right:8px;}
/* Responsive */
@media(max-width:1024px){aside{transform:translateX(-100%); width:200px; position:fixed; z-index:100;} aside.active{transform:translateX(0);} aside h2 .close-btn{display:inline;} main{margin-left:0;} .hamburger{display:block;}}
</style>
</head>
<body>

<aside id="sidebar">
  <h2>Nyame Na Aye <span class="close-btn" onclick="toggleSidebar()">‚úñ</span></h2>
  <nav>
    <a onclick="loadPage('dashboard')">üìà <span>Dashboard</span></a>
    <a onclick="loadPage('products')">üì¶ <span>Products</span></a>
    <a onclick="loadPage('sales')">üí≥ <span>Sales</span></a>
    <a onclick="loadPage('reports')">üìë <span>Reports</span></a>
    <a onclick="loadPage('settings')">‚öôÔ∏è <span>Settings</span></a>
    <a class="logout" onclick="logout()">üö™ Logout</a>
  </nav>
</aside>

<main>
<header>
  <div style="display:flex; align-items:center;">
    <span class="hamburger" onclick="toggleSidebar()">‚ò∞</span>
    <h1 id="pageTitle">Dashboard</h1>
  </div>
  <div class="user-info">
    <img src="logo.png" id="userImage" alt="User">
    <span id="userName"></span>
    <span id="loginTime"></span>
  </div>
</header>

<!-- Dashboard Section -->
<section id="dashboardSection" class="active">
  <div class="cards">
    <div class="card"><span class="icon">üí∞</span><div class="title">Sales Today</div><div class="value" id="salesToday">GHS 0</div></div>
    <div class="card"><span class="icon">üìä</span><div class="title">Profit</div><div class="value" id="profitToday">GHS 0</div></div>
    <div class="card"><span class="icon">üì¶</span><div class="title">Total Quantity</div><div class="value" id="totalQuantity">0 items</div></div>
    <div class="card"><span class="icon">‚ö†Ô∏è</span><div class="title">Low Stock</div><div class="value" id="lowStock">0 items</div></div>
  </div>
  <div class="card chart-container"><canvas id="salesChart" style="max-width:100%;"></canvas></div>
</section>

<!-- Products Section -->
<section id="productsSection">
  <h2>Products</h2>
  <form id="productForm">
    <input id="productName" placeholder="Product Name" required>
    <input type="number" id="productStock" placeholder="Stock" min="0" required>
    <input type="number" id="productPrice" placeholder="Price" step="0.01" min="0" required>
    <button type="submit">Add Product</button>
  </form>
  <input class="search-box" id="productSearch" placeholder="Search Product..." oninput="searchProducts()">
  <table>
    <thead><tr><th>#</th><th>Name</th><th>Stock</th><th>Price</th><th>Action</th></tr></thead>
    <tbody id="productTable"></tbody>
  </table>
</section>

<!-- Sales Section -->
<section id="salesSection">
  <h2>Sales</h2>
  <form id="saleForm">
    <select id="saleProduct" required onchange="updateStockInfo()"></select>
    <input type="number" id="saleQuantity" placeholder="Quantity" required min="1">
    <span id="availableStock" style="font-size:12px;color:gray;"></span>
    <button type="submit">Add Sale</button>
  </form>
  <input class="search-box" id="saleSearch" placeholder="Search Sale..." oninput="searchSales()">
  <table>
    <thead><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th><th>Action</th></tr></thead>
    <tbody id="salesTable"></tbody>
  </table>
</section>

<!-- Reports Section -->
<section id="reportsSection">
  <h2>Reports</h2>
  <button onclick="printReport()">üñ®Ô∏è Print Report</button>
  <div id="reportContent" style="margin-top:10px;"></div>
</section>

<!-- Settings Section -->
<section id="settingsSection">
  <h2>Settings</h2>
  <div class="settings">
    <label>Theme:</label>
    <select id="themeSelect" onchange="changeTheme()">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
  </div>
</section>
</main>

<div id="loadingOverlay"><div class="spinner"></div></div>

<script>
// ------------------ User Info ------------------
async function getUser(){
    try{
        const res = await fetch("/api/user"); // optional, or keep localStorage
        user = JSON.parse(localStorage.getItem("user")||"{}");
        if(!user.username) window.location.href="/";
        document.getElementById("userName").textContent = user.username;
        document.getElementById("loginTime").textContent = new Date().toLocaleTimeString();
    }catch(e){ console.error(e); }
}
getUser();

// ------------------ Sidebar ------------------
function toggleSidebar(){document.getElementById("sidebar").classList.toggle("active");}
function loadPage(page){
  document.querySelectorAll("main section").forEach(s=>s.classList.remove("active"));
  document.getElementById(page+"Section").classList.add("active");
  document.getElementById("pageTitle").textContent = page.charAt(0).toUpperCase()+page.slice(1);
}
function logout(){localStorage.removeItem("user"); window.location.href="/";}
function changeTheme(){document.body.className = document.getElementById("themeSelect").value;}

// ------------------ Data ------------------
let products = [];
let sales = [];

// ------------------ Products ------------------
async function loadProducts(){
    const res = await fetch("/api/products");
    products = await res.json();
    renderProducts();
}
function renderProducts(){
    const tbody = document.getElementById("productTable");
    tbody.innerHTML="";
    products.forEach((p,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.stock}</td><td>GHS ${p.price.toFixed(2)}</td>
        <td><button class="btn-edit" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
        <button class="btn-delete" onclick="deleteProduct(${p.id})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
    });
    updateSalesProductSelect();
    updateDashboardCards();
}
function updateSalesProductSelect(){
    const select = document.getElementById("saleProduct");
    select.innerHTML="";
    products.forEach(p=>select.innerHTML+=`<option value="${p.id}">${p.name}</option>`);
}
document.getElementById("productForm").onsubmit=async e=>{
    e.preventDefault();
    const name = document.getElementById("productName").value;
    const stock = parseInt(document.getElementById("productStock").value);
    const price = parseFloat(document.getElementById("productPrice").value);
    await fetch("/api/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,stock,price})});
    await loadProducts();
    e.target.reset();
}
async function editProduct(id){
    const p = products.find(x=>x.id===id);
    const name = prompt("Product Name",p.name);
    const stock = parseInt(prompt("Stock",p.stock));
    const price = parseFloat(prompt("Price",p.price));
    if(!name || isNaN(stock) || isNaN(price)) return;
    await fetch(`/api/products/${id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,stock,price})});
    await loadProducts();
}
async function deleteProduct(id){if(!confirm("Delete product?")) return; await fetch(`/api/products/${id}`,{method:"DELETE"}); await loadProducts();}

// ------------------ Sales ------------------
async function loadSales(){
    const res = await fetch("/api/sales");
    sales = await res.json();
    renderSales();
}
function renderSales(){
    const tbody=document.getElementById("salesTable");
    tbody.innerHTML="";
    sales.forEach((s,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td>
        <td><button class="btn-delete" onclick="deleteSale(${s.id})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
    });
    updateDashboardCards();
}
document.getElementById("saleForm").onsubmit=async e=>{
    e.preventDefault();
    const product_id = parseInt(document.getElementById("saleProduct").value);
    const qty = parseInt(document.getElementById("saleQuantity").value);
    const product = products.find(p=>p.id===product_id);
    if(qty>product.stock){alert("Insufficient stock!"); return;}
    const res = await fetch("/api/sales",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id,qty})});
    const data = await res.json();
    if(data.error){alert(data.error); return;}
    await loadProducts(); await loadSales();
    e.target.reset();
}
async function deleteSale(id){if(!confirm("Delete sale?")) return; await fetch(`/api/sales/${id}`,{method:"DELETE"}); await loadProducts(); await loadSales();}

// ------------------ Stock Info ------------------
function updateStockInfo(){
    const id=parseInt(document.getElementById("saleProduct").value);
    const p=products.find(x=>x.id===id);
    document.getElementById("availableStock").textContent=`Available: ${p.stock}`;
}

// ------------------ Search ------------------
function searchProducts(){
    const term=document.getElementById("productSearch").value.toLowerCase();
    const tbody=document.getElementById("productTable");
    tbody.innerHTML="";
    products.filter(p=>p.name.toLowerCase().includes(term)).forEach((p,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.stock}</td><td>GHS ${p.price.toFixed(2)}</td>
        <td><button class="btn-edit" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
        <button class="btn-delete" onclick="deleteProduct(${p.id})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
    });
}
function searchSales(){
    const term=document.getElementById("saleSearch").value.toLowerCase();
    const tbody=document.getElementById("salesTable");
    tbody.innerHTML="";
    sales.filter(s=>s.product.toLowerCase().includes(term)).forEach((s,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td>
        <td><button class="btn-delete" onclick="deleteSale(${s.id})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
    });
}

// ------------------ Dashboard Cards ------------------
function updateDashboardCards(){
    const today = new Date().toLocaleDateString();
    const salesToday = sales.reduce((a,s)=>a+(s.date===today?s.amount:0),0);
    const profitToday = salesToday*0.2;
    const totalQuantity = products.reduce((a,p)=>a+p.stock,0);
    const lowStock = products.filter(p=>p.stock<5).length;
    document.getElementById("salesToday").textContent=`GHS ${salesToday.toFixed(2)}`;
    document.getElementById("profitToday").textContent=`GHS ${profitToday.toFixed(2)}`;
    document.getElementById("totalQuantity").textContent=totalQuantity+" items";
    document.getElementById("lowStock").textContent=lowStock+" items";
}

// ------------------ Chart ------------------
const ctx=document.getElementById('salesChart').getContext('2d');
const chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Sales',data:[],borderColor:'var(--primary-color)',backgroundColor:'rgba(59,130,246,0.2)',tension:0.4}]},options:{responsive:true}});
function updateChart(){chart.data.labels=sales.map(s=>s.date); chart.data.datasets[0].data=sales.map(s=>s.amount); chart.update();}

// ------------------ Reports ------------------
function printReport(){
    let html="<h3>Sales Report</h3><table><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th></tr>";
    sales.forEach((s,i)=>html+=`<tr><td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td></tr>`);
    html+="</table>";
    const win=window.open('','','width=800,height=600');
    win.document.write(html);
    win.print();
}

// ------------------ Init ------------------
async function init(){await loadProducts(); await loadSales(); updateChart();}
init();
</script>

</body>
</html>
