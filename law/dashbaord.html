<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nyame Na Aye - Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root { --bg-color:#f3f4f6; --text-color:#333; --card-bg:#fff; --primary-color:#3b82f6;}
body.dark { --bg-color:#121212; --text-color:#e0e0e0; --card-bg:#1e1e1e; --primary-color:#10b981;}
body {margin:0; font-family:Arial,sans-serif; display:flex; min-height:100vh; background:var(--bg-color); color:var(--text-color);}
aside {width:200px; background:var(--card-bg); padding:35px 15px; position:fixed; height:100%; overflow:auto;}
aside h2 {font-size:20px; margin-bottom:15px;}
aside nav a {display:block; padding:6px 10px; margin-bottom:5px; text-decoration:none; color:var(--text-color); border-radius:6px;}
aside nav a:hover {background:rgba(59,130,246,0.1); color:var(--primary-color);}
aside nav a.logout {margin-top:auto;}
main {flex:1; margin-left:200px; padding:15px;}
header {display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;}
header h1 {margin:0;}
.user-info {display:flex; gap:8px; align-items:center;}
.user-info img {width:35px; height:35px; border-radius:50%;}
.cards {display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-bottom:15px;}
.card {background:var(--card-bg); padding:10px; border-radius:10px; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
section {display:none;}
section.active {display:block;}
table {width:100%; border-collapse:collapse; margin-top:10px;}
th, td {padding:6px; border:1px solid #ddd; text-align:left;}
th {background:#f3f4f6;}
button {padding:4px 8px; border:none; border-radius:6px; cursor:pointer; background:var(--primary-color); color:#fff;}
button:hover {opacity:0.9;}
input, select {padding:5px; margin:4px 0; border-radius:6px; border:1px solid #ccc; width:100%; box-sizing:border-box;}
</style>
</head>
<body>

<aside>
  <h2>Nyame Na Aye</h2>
  <nav>
    <a onclick="loadPage('dashboard')">Dashboard</a>
    <a onclick="loadPage('products')">Products</a>
    <a onclick="loadPage('sales')">Sales</a>
    <a onclick="loadPage('reports')">Reports</a>
    <a onclick="loadPage('settings')">Settings</a>
    <a class="logout" onclick="logout()">Logout</a>
  </nav>
</aside>

<main>
<header>
  <h1 id="pageTitle">Dashboard</h1>
  <div class="user-info">
    <img src="logo.png" id="userImage" alt="User">
    <span id="userName"></span>
  </div>
</header>

<!-- Dashboard Section -->
<section id="dashboardSection" class="active">
  <div class="cards">
    <div class="card"><div class="title">Sales Today</div><div class="value" id="salesToday">GHS 0</div></div>
    <div class="card"><div class="title">Profit</div><div class="value" id="profitToday">GHS 0</div></div>
    <div class="card"><div class="title">Total Quantity</div><div class="value" id="totalQuantity">0 items</div></div>
    <div class="card"><div class="title">Low Stock</div><div class="value" id="lowStock">0 items</div></div>
  </div>
  <div class="card"><canvas id="salesChart"></canvas></div>
</section>

<!-- Products Section -->
<section id="productsSection">
  <h2>Products</h2>
  <form id="productForm">
    <input id="productName" placeholder="Product Name" required>
    <input type="number" id="productStock" placeholder="Stock" min="0" required>
    <input type="number" id="productPrice" placeholder="Price" step="0.01" min="0" required>
    <button type="submit">Add Product</button>
  </form>
  <input id="productSearch" placeholder="Search Product..." oninput="searchProducts()">
  <table>
    <thead><tr><th>#</th><th>Name</th><th>Stock</th><th>Price</th><th>Action</th></tr></thead>
    <tbody id="productTable"></tbody>
  </table>
</section>

<!-- Sales Section -->
<section id="salesSection">
  <h2>Sales</h2>
  <form id="saleForm">
    <select id="saleProduct" required onchange="updateStockInfo()"></select>
    <input type="number" id="saleQuantity" placeholder="Quantity" min="1" required>
    <span id="availableStock" style="font-size:12px;color:gray;"></span>
    <button type="submit">Add Sale</button>
  </form>
  <input id="saleSearch" placeholder="Search Sale..." oninput="searchSales()">
  <table>
    <thead><tr><th>#</th><th>Date</th><th>Product</th><th>Qty</th><th>Amount</th><th>Action</th></tr></thead>
    <tbody id="salesTable"></tbody>
  </table>
</section>

<!-- Reports Section -->
<section id="reportsSection">
  <h2>Reports</h2>
  <button onclick="printReport()">Print Report</button>
  <div id="reportContent"></div>
</section>

<!-- Settings Section -->
<section id="settingsSection">
  <h2>Settings</h2>
  <label>Theme:</label>
  <select id="themeSelect" onchange="changeTheme()">
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  </select>
</section>
</main>

<script>
// ---------------- User Info ----------------
const user = JSON.parse(localStorage.getItem("user")||"{}");
if(!user.username) window.location.href="/";
document.getElementById("userName").textContent = user.username;

// ---------------- Sidebar ----------------
function loadPage(page){document.querySelectorAll("main section").forEach(s=>s.classList.remove("active")); document.getElementById(page+"Section").classList.add("active"); document.getElementById("pageTitle").textContent=page.charAt(0).toUpperCase()+page.slice(1);}
function logout(){localStorage.removeItem("user"); window.location.href="/";}
function changeTheme(){document.body.className = document.getElementById("themeSelect").value;}

// ---------------- Data ----------------
let products=[], sales=[];

// ---------------- Products ----------------
async function loadProducts(){
    const res = await fetch("/api/products");
    products = await res.json();
    renderProducts();
}
function renderProducts(){
    const tbody = document.getElementById("productTable");
    tbody.innerHTML="";
    products.forEach((p,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.stock}</td><td>GHS ${p.price.toFixed(2)}</td>
        <td><button onclick="editProduct(${p.id})">‚úèÔ∏è</button>
        <button onclick="deleteProduct(${p.id})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
    });
    updateSalesProductSelect();
    updateDashboardCards();
}
function updateSalesProductSelect(){
    const select = document.getElementById("saleProduct");
    select.innerHTML="";
    products.forEach(p=>select.innerHTML+=`<option value="${p.id}">${p.name}</option>`);
}
document.getElementById("productForm").onsubmit=async e=>{
    e.preventDefault();
    const name=document.getElementById("productName").value;
    const stock=parseInt(document.getElementById("productStock").value);
    const price=parseFloat(document.getElementById("productPrice").value);
    await fetch("/api/products",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,stock,price})});
    await loadProducts();
    e.target.reset();
}
async function editProduct(id){
    const p=products.find(x=>x.id===id);
    const name=prompt("Product Name",p.name);
    const stock=parseInt(prompt("Stock",p.stock));
    const price=parseFloat(prompt("Price",p.price));
    if(!name||isNaN(stock)||isNaN(price)) return;
    await fetch(`/api/products/${id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,stock,price})});
    await loadProducts();
}
async function deleteProduct(id){if(!confirm("Delete product?")) return; await fetch(`/api/products/${id}`,{method:"DELETE"}); await loadProducts();}

// ---------------- Sales ----------------
async function loadSales(){
    const res = await fetch("/api/sales");
    sales = await res.json();
    renderSales();
}
function renderSales(){
    const tbody=document.getElementById("salesTable");
    tbody.innerHTML="";
    sales.forEach((s,i)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td>
        <td><button onclick="deleteSale(${s.id})">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
    });
    updateDashboardCards();
}
document.getElementById("saleForm").onsubmit=async e=>{
    e.preventDefault();
    const product_id=parseInt(document.getElementById("saleProduct").value);
    const qty=parseInt(document.getElementById("saleQuantity").value);
    const product=products.find(p=>p.id===product_id);
    if(qty>product.stock){alert("Insufficient stock!"); return;}
    const res = await fetch("/api/sales",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id,qty})});
    const data = await res.json();
    if(data.error){alert(data.error); return;}
    await loadProducts(); await loadSales();
    e.target.reset();
}
async function deleteSale(id){if(!confirm("Delete sale?")) return; await fetch(`/api/sales/${id}`,{method:"DELETE"}); await loadProducts(); await loadSales();}
function updateStockInfo(){const id=parseInt(document.getElementById("saleProduct").value); const p=products.find(x=>x.id===id); document.getElementById("availableStock").textContent=`Available: ${p.stock}`;}
function searchProducts(){const term=document.getElementById("productSearch").value.toLowerCase(); const tbody=document.getElementById("productTable"); tbody.innerHTML=""; products.filter(p=>p.name.toLowerCase().includes(term)).forEach((p,i)=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${p.name}</td><td>${p.stock}</td><td>GHS ${p.price.toFixed(2)}</td>
<td><button onclick="editProduct(${p.id})">‚úèÔ∏è</button><button onclick="deleteProduct(${p.id})">üóëÔ∏è</button></td>`; tbody.appendChild(tr);});}
function searchSales(){const term=document.getElementById("saleSearch").value.toLowerCase(); const tbody=document.getElementById("salesTable"); tbody.innerHTML=""; sales.filter(s=>s.product.toLowerCase().includes(term)).forEach((s,i)=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${s.date}</td><td>${s.product}</td><td>${s.qty}</td><td>GHS ${s.amount.toFixed(2)}</td><td><button onclick="deleteSale(${s.id})">üóëÔ∏è</button></td>`; tbody.appendChild(tr);});}

// ---------------- Dashboard ----------------
function updateDashboardCards(){
    const today = new Date().toISOString().split('T')[0];
    const salesToday = sales.reduce((a,s)=>a+(s.date===today?s.amount:0),0);
    const profitToday = salesToday*0.2;
    const totalQuantity = products.reduce((a,p)=>a+p.stock,0);
    const lowStock = products.filter(p=>p.stock<5).length;
    document.getElementById("salesToday").textContent=`GHS ${salesToday.toFixed(2)}`;
    document.getElementById("profitToday").textContent=`GHS ${profitToday.toFixed(2)}`;
    document.getElementById("totalQuantity").textContent=`${totalQuantity} items`;
    document.getElementById("lowStock").textContent=`${lowStock} items`;
    renderSalesChart();
}
function renderSalesChart(){
    const ctx = document.getElementById('salesChart').getContext('2d');
    if(window.salesChartObj) window.salesChartObj.destroy();
    const dates = [...new Set(sales.map(s=>s.date))];
    const amounts = dates.map(d=>sales.filter(s=>s.date===d).reduce((a,s)=>a+s.amount,0));
    window.salesChartObj = new Chart(ctx,{type:'line',data:{labels:dates,datasets:[{label:'Sales',data:amounts, borderColor:'blue',backgroundColor:'rgba(0,0,255,0.2)'}]}, options:{responsive:true}});
}

// ---------------- Reports ----------------
function printReport(){const rep=document.getElementById("reportContent"); rep.innerHTML=`<h3>Sales Report</h3><pre>${JSON.stringify(sales,null,2)}</pre>`;}
  
// ---------------- Init ----------------
loadProducts();
loadSales();
</script>

</body>
</html>
