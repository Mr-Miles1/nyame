<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Store System - Authentication</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      margin: 0;
    }
    .auth-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0px 4px 15px rgba(0,0,0,0.2);
      padding: 2rem;
      width: 100%;
      max-width: 400px;
      animation: fadeIn 0.5s ease-in-out;
    }
    .auth-card h3 {
      text-align: center;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    .switch-link {
      cursor: pointer;
      color: #007bff;
    }
    .switch-link:hover {
      text-decoration: underline;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div class="auth-card" id="loginCard">
    <h3>üîë Store Login</h3>
    <form id="loginForm">
      <div class="mb-3">
        <label>Username</label>
        <input type="text" class="form-control" id="loginUsername" required>
      </div>
      <div class="mb-3">
        <label>Password</label>
        <input type="password" class="form-control" id="loginPassword" required>
      </div>
      <button type="submit" class="btn btn-primary w-100" id="loginBtn">
        <span id="loginText">Login</span>
        <span id="loginSpinner" class="spinner-border spinner-border-sm d-none"></span>
      </button>
    </form>
    <div class="text-center mt-3">
      <small><span class="switch-link" onclick="showRegister()">Create Account</span> | <span class="switch-link" onclick="showForgot()">Forgot Password?</span></small>
    </div>
    <div id="loginMsg" class="mt-3 text-center"></div>
  </div>

  <!-- Register Form -->
  <div class="auth-card d-none" id="registerCard">
    <h3>üìù Sign Up</h3>
    <form id="registerForm">
      <div class="mb-3">
        <label>Full Name</label>
        <input type="text" class="form-control" id="regFullname" required>
      </div>
      <div class="mb-3">
        <label>Username</label>
        <input type="text" class="form-control" id="regUsername" required>
      </div>
      <div class="mb-3">
        <label>Password</label>
        <input type="password" class="form-control" id="regPassword" required>
      </div>
      <div class="mb-3">
        <label>Role</label>
        <select id="regRole" class="form-control">
          <option value="storekeeper">Storekeeper</option>
          <option value="cashier">Cashier</option>
          <option value="admin">Admin</option>
          <option value="owner">Owner</option>
        </select>
      </div>
      <button type="submit" class="btn btn-success w-100" id="registerBtn">
        <span id="registerText">Register</span>
        <span id="registerSpinner" class="spinner-border spinner-border-sm d-none"></span>
      </button>
    </form>
    <div class="text-center mt-3">
      <small><span class="switch-link" onclick="showLogin()">Already have an account? Login</span></small>
    </div>
    <div id="registerMsg" class="mt-3 text-center"></div>
  </div>

  <!-- Forgot Password Form -->
  <div class="auth-card d-none" id="forgotCard">
    <h3>üîÑ Reset Password</h3>
    <form id="forgotForm">
      <div class="mb-3">
        <label>Enter Username or Email</label>
        <input type="text" class="form-control" id="forgotUser" required>
      </div>
      <button type="submit" class="btn btn-warning w-100">
        Send Reset Link
      </button>
    </form>
    <div class="text-center mt-3">
      <small><span class="switch-link" onclick="showLogin()">Back to Login</span></small>
    </div>
    <div id="forgotMsg" class="mt-3 text-center"></div>
  </div>

  <script>
    // Switch forms
    function showRegister() {
      document.getElementById("loginCard").classList.add("d-none");
      document.getElementById("registerCard").classList.remove("d-none");
      document.getElementById("forgotCard").classList.add("d-none");
    }
    function showLogin() {
      document.getElementById("loginCard").classList.remove("d-none");
      document.getElementById("registerCard").classList.add("d-none");
      document.getElementById("forgotCard").classList.add("d-none");
    }
    function showForgot() {
      document.getElementById("loginCard").classList.add("d-none");
      document.getElementById("registerCard").classList.add("d-none");
      document.getElementById("forgotCard").classList.remove("d-none");
    }

    // Login
    document.getElementById("loginForm").onsubmit = async (e) => {
      e.preventDefault();
      document.getElementById("loginText").classList.add("d-none");
      document.getElementById("loginSpinner").classList.remove("d-none");

      try {
        let res = await fetch("http://127.0.0.1:5000/api/login", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            username: document.getElementById("loginUsername").value,
            password: document.getElementById("loginPassword").value
          })
        });

        let data = await res.json();

        document.getElementById("loginText").classList.remove("d-none");
        document.getElementById("loginSpinner").classList.add("d-none");

        if (res.ok) {
          localStorage.setItem("token", data.token);
          localStorage.setItem("role", data.role);
          document.getElementById("loginMsg").innerHTML =
            `<span class="text-success">‚úÖ ${data.message || "Login successful!"}</span>`;
          setTimeout(() => window.location.href = "index.html", 1500);
        } else {
          document.getElementById("loginMsg").innerHTML =
            `<span class="text-danger">‚ùå ${data.message || "Login failed"}</span>`;
        }
      } catch (err) {
        document.getElementById("loginText").classList.remove("d-none");
        document.getElementById("loginSpinner").classList.add("d-none");
        document.getElementById("loginMsg").innerHTML =
          `<span class="text-danger">‚ùå Error connecting to server</span>`;
      }
    };

    // Register
    document.getElementById("registerForm").onsubmit = async (e) => {
      e.preventDefault();
      document.getElementById("registerText").classList.add("d-none");
      document.getElementById("registerSpinner").classList.remove("d-none");

      try {
        let res = await fetch("http://127.0.0.1:5000/api/register", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            full_name: document.getElementById("regFullname").value,
            username: document.getElementById("regUsername").value,
            password: document.getElementById("regPassword").value,
            role: document.getElementById("regRole").value
          })
        });

        let data = await res.json();

        document.getElementById("registerText").classList.remove("d-none");
        document.getElementById("registerSpinner").classList.add("d-none");

        if (res.ok) {
          document.getElementById("registerMsg").innerHTML =
            `<span class="text-success">‚úÖ ${data.message || "Registered successfully! Please login."}</span>`;
          setTimeout(() => showLogin(), 2000);
        } else {
          document.getElementById("registerMsg").innerHTML =
            `<span class="text-danger">‚ùå ${data.message || "Registration failed"}</span>`;
        }
      } catch (err) {
        document.getElementById("registerText").classList.remove("d-none");
        document.getElementById("registerSpinner").classList.add("d-none");
        document.getElementById("registerMsg").innerHTML =
          `<span class="text-danger">‚ùå Error connecting to server</span>`;
      }
    };

    // Forgot Password
    document.getElementById("forgotForm").onsubmit = (e) => {
      e.preventDefault();
      document.getElementById("forgotMsg").innerHTML =
        `<span class="text-info">üì© If this account exists, a reset link was sent.</span>`;
      setTimeout(() => showLogin(), 2000);
    };
  </script>
</body>
</html>
